---

# Run as tfc_prod user

- name: Create virtual env
  command: python3 -m venv tfc_web_venv
  args:
    chdir: ~tfc_prod
    creates: ~tfc_prod/tfc_web_venv

- name: Snapshot the current tfc_web source
  git:
    repo: https://github.com/SmartCambridge/tfc_web
    dest: ~tfc_prod/tfc_web
    update: no

- name: Install production secrets
  gpg_d:
    src: secrets.py.asc
    dest: ~tfc_prod/tfc_web/tfc_web/tfc_web/secrets.py
    owner: tfc_prod
    group: tfc_prod
    mode: "u=rw,go="

# Ansible's 'pip' module doesn't seem to work...
- name: Install Python dependancies
  command: ~tfc_prod/tfc_web_venv/bin/pip install -r ~tfc_prod/tfc_web/tfc_web/requirements.txt
  changed_when: false

- name: Run migrations
  command: ~tfc_prod/tfc_web_venv/bin/python manage.py migrate
  args:
    chdir: ~tfc_prod/tfc_web/tfc_web
  changed_when: false

- name: Collect static files
  command: ~tfc_prod/tfc_web_venv/bin/python manage.py collectstatic --no-input
  args:
    chdir: ~tfc_prod/tfc_web/tfc_web
  register: command_result
  changed_when: command_result.stdout is search('Copying')

- name: Setup the tfc_prod Django user
  command: ~tfc_prod/tfc_web_venv/bin/python manage.py setup_tfc_prod
  args:
    chdir: ~tfc_prod/tfc_web/tfc_web
  register: command_result
  changed_when: command_result.stdout is search('token created')

- name: Route cron email somewhere useful
  cron:
    name: MAILTO
    env: yes
    value: admin@smartcambridge.org

- name: Bus stop reload cronjob
  cron:
    name: reload bus stops
    state: present
    user: tfc_prod
    minute: 0
    hour: 3
    day: 1
    job: 'cd /home/tfc_prod/tfc_web/tfc_web/ && /home/tfc_prod/tfc_web_venv/bin/python /home/tfc_prod/tfc_web/tfc_web/manage.py update_bus_stops --settings="tfc_web.settings_production" >/var/log/tfc_prod/update_bus_stops.err 2>&1 && echo $(date --iso-8601=seconds) > /var/log/tfc_prod/update_bus_stops.timestamp'

- name: Bus timetable reload cronjob
  cron:
    name: reload bus timetable
    state: present
    user: tfc_prod
    minute: 0
    hour: 3
    weekday: wed
    job: 'cd /home/tfc_prod/tfc_web/tfc_web/ && /home/tfc_prod/tfc_web_venv/bin/python /home/tfc_prod/tfc_web/tfc_web/manage.py update_bus_info --settings="tfc_web.settings_production" >/var/log/tfc_prod/update_bus_info.err 2>&1 && echo $(date --iso-8601=seconds) > /var/log/tfc_prod/update_bus_info.timestamp'

- name: Session clearout cronjob
  cron:
    name: crearout sessions
    state: present
    user: tfc_prod
    minute: 0
    hour: 2
    weekday: tue
    job: 'cd /home/tfc_prod/tfc_web/tfc_web/ && /home/tfc_prod/tfc_web_venv/bin/python /home/tfc_prod/tfc_web/tfc_web/manage.py clearsessions --settings="tfc_web.settings_production"'
